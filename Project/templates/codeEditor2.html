<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.css" />
</head>

<body>
  <form method="post" id="runcode">
    {% csrf_token %}
    <select id="language">
      <option value="python">Python</option>
      <option value="c">C</option>
      <option value="cpp">C++</option>
      <option value="javascript">JavaScript</option>
    </select>
    <textarea id="editor"></textarea>
    <button type="submit" onclick="runCode()"
      class="bg-blue-500 text-white font-bold py-2 px-4 rounded mt-4 hover:bg-blue-700">Run</button>

    <p class="block text-gray-700 font-bold mb-2 mt-6">Console output:</p>
    <div class="boder border-gray-400" id="console"></div>
    <div id="output"></div>
  </form>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/python/python.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/javascript/javascript.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/show-hint.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/python-hint.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/javascript-hint.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/clike/clike.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/cmake/cmake.js"></script>



  <script>
    let lang_dic = {
      python: `print("hello world")`,
      "c++": `#include <iostream>
    using namespace std;

    int main() {
      cout << "Hello World!";
      return 0;
    }`,
      c: `#include <stdio.h>

    int main() {
      printf("Hello World!");
      return 0;
    }`,
      javascript: `console.log("hello world");`,
      dart: `void main(){
      print("Hello World");
    }`,
    };


    var editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
      mode: "text/x-python",
      lineNumbers: true,
      gutters: ["CodeMirror-lint-markers"],
      lint: true,
      extraKeys: { "Ctrl-Space": "autocomplete" }
    });


    // Get the language selector element
    var langSelect = document.getElementById("language");

    // Event listener for when the language is changed
    langSelect.addEventListener("change", function (event) {
      // Get the selected language
      var lang = event.target.value;

      // Set the CodeMirror mode based on the selected language
      switch (lang) {
        case "python":
          editor.setOption("mode", "text/x-python");
          editor.setValue(lang_dic["python"]);
          break;
        case "c":
          editor.setOption("mode", "text/x-csrc");
          editor.setValue(lang_dic["c"]);
          break;
        case "cpp":
          editor.setOption("mode", "text/x-c++src");
          editor.setValue(lang_dic["c++"]);
          break;
        case "javascript":
          editor.setOption("mode", "text/javascript");
          editor.setValue(lang_dic["javascript"]);
          break;
        default:
          editor.setOption("mode", "text/x-python");
          editor.setValue(lang_dic["python"]);
          break;
      }
    });


    function runCode() {
      event.preventDefault(); // prevent form submission
      var csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
      var language = $('#language').val();
      var code = editor.getValue();
      $.ajax({
        url: "/app/codeEditor2/run_code/",
        type: "POST",
        dataType: "json",
        data: { code: code, lang: language, csrfmiddlewaretoken: csrf_token },
        success: function (response) {
          if (response.success) {
            var result = response.result.replace(/\n/g, '<br>');
            if (result.includes('SyntaxError') || result.includes('NameError') || result.includes('TypeError')) {
              // Display the result in the #output div
              console.log('failed');
              window.parent.postMessage({ result: 'failed', language: data}, '*');
            } else {
              console.log('pass');
              window.parent.postMessage({ result: 'success' , language: data}, '*');
            }
            $("#output").html(result);
              
          } else {
            var errorLines = response.error.split('\n');
            var errorHtml = errorLines.map(function (line) {
              return '<div>' + line + '</div>';
            }).join('');
            $("#output").html(errorHtml);
            window.parent.postMessage({ result: 'failed' }, '*');
          }
        },
        error: function (xhr) {
          console.log(xhr.statusText);
        }
      });
    }


  </script>
</body>

</html>